<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SQL Vizualiz√©r ‚Äî Interaktivn√≠ v√Ωukov√Ω n√°stroj</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0d1117; --bg2: #161b22; --bg3: #1c2128; --bg4: #21262d;
  --border: #30363d; --border2: #484f58;
  --text: #e6edf3; --text2: #8b949e; --text3: #6e7681;
  --blue: #58a6ff; --green: #3fb950; --yellow: #d29922;
  --purple: #bc8cff; --pink: #f778ba; --red: #ff7b72;
  --cyan: #56d4dd; --orange: #f0883e;
  --lightgreen: #7ee787; --lightred: #ffa198;
}
html, body { height: 100%; }
body { background: var(--bg); color: var(--text); font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; }

/* ===== LAYOUT ===== */
.app { display: flex; flex-direction: column; height: 100vh; }
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 20px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.header h1 { font-size: 15px; font-weight: 700; }
.header h1 span { color: var(--blue); }
.main-content { display: flex; flex: 1; overflow: hidden; }
.col-left { width: 50%; min-width: 280px; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
.col-right { flex: 1; min-width: 280px; display: flex; flex-direction: column; position: relative; }

/* ===== EDITOR (compact, top-left) ===== */
.editor-section { flex: 35; min-height: 60px; display: flex; flex-direction: column; overflow: visible; position: relative; z-index: 10; }
.editor-toolbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 6px 16px; background: var(--bg2); border-bottom: 1px solid var(--border);
}
.editor-toolbar-left { display: flex; align-items: center; gap: 8px; }
.editor-toolbar-title { font-size: 11px; color: var(--text3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.editor-toolbar-right { display: flex; gap: 6px; }

.editor-wrap {
  position: relative; flex: 1; min-height: 40px; overflow: hidden; background: var(--bg);
}
.editor-line-numbers {
  position: absolute; left: 0; top: 0; width: 36px;
  padding: 10px 6px 10px 0; text-align: right;
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  line-height: 1.6; color: var(--text3); user-select: none;
  pointer-events: none; z-index: 2; overflow: hidden;
  white-space: pre;
}
.editor-highlight {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  padding: 10px 10px 10px 44px;
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  line-height: 1.6; white-space: pre; overflow: auto;
  pointer-events: none; z-index: 1; color: var(--text);
}
.editor-textarea {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  padding: 10px 10px 10px 44px;
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  line-height: 1.6; color: transparent; caret-color: var(--text);
  background: transparent; border: none; outline: none; resize: none;
  white-space: pre; overflow: auto;
  z-index: 3; tab-size: 2;
}
.editor-textarea::selection { background: rgba(88,166,255,0.25); }

/* Clause order warning */
.clause-warning {
  display: none; padding: 6px 12px;
  background: rgba(255,85,85,0.12); border-top: 1px solid rgba(255,85,85,0.3);
  font-size: 12px; color: #ff5555; line-height: 1.5;
}
.clause-warning.visible { display: block; }
.clause-warning span { display: block; }

/* Syntax colors */
.syn-select { color: var(--blue); font-weight: 600; }
.syn-from { color: var(--green); font-weight: 600; }
.syn-where { color: var(--yellow); font-weight: 600; }
.syn-join { color: var(--purple); font-weight: 600; }
.syn-group { color: var(--pink); font-weight: 600; }
.syn-having { color: var(--red); font-weight: 600; }
.syn-order { color: var(--cyan); font-weight: 600; }
.syn-agg { color: var(--orange); font-weight: 600; }
.syn-string { color: var(--lightgreen); }
.syn-number { color: var(--lightred); }
.syn-operator { color: var(--text2); }
.syn-paren { color: var(--text2); }
.syn-star { color: var(--text); }
.syn-alias { color: var(--text2); font-style: italic; }
.syn-comma { color: var(--text3); }
.syn-dot { color: var(--text3); }
.syn-comment { color: var(--text3); font-style: italic; }

/* ===== BUTTONS ===== */
.btn {
  padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border);
  background: var(--bg3); color: var(--text); font-size: 11px;
  font-weight: 500; cursor: pointer; transition: all 0.15s;
  display: flex; align-items: center; gap: 4px; font-family: 'Inter', sans-serif;
}
.btn:hover { background: var(--bg4); border-color: var(--border2); }
.btn-primary { background: #1f6feb; border-color: #1f6feb; color: #fff; }
.btn-primary:hover { background: #388bfd; }
.btn-success { background: rgba(63,185,80,0.15); border-color: var(--green); color: var(--green); }
.btn-success:hover { background: rgba(63,185,80,0.25); }
.btn kbd {
  background: rgba(255,255,255,0.1); padding: 1px 4px; border-radius: 3px;
  font-size: 9px; font-family: 'JetBrains Mono', monospace;
}

/* ===== PIPELINE ===== */
.pipeline-section {
  flex: 35; display: flex; flex-direction: column; overflow: hidden;
  background: var(--bg); min-height: 100px; position: relative;
  border-bottom: 1px solid var(--border);
}
.pipeline-header {
  padding: 6px 16px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.pipeline-header-title { font-size: 11px; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

/* ===== DATAFLOW SECTION ===== */
.dataflow-section { flex: 65; min-height: 80px; display: flex; flex-direction: column; overflow: hidden; border-top: 1px solid var(--border); }
.dataflow-header {
  padding: 6px 16px; background: var(--bg2);
  border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.timeline-top { display: flex; align-items: center; justify-content: space-between; }
.timeline-title { font-size: 11px; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.timeline-step-label { font-size: 10px; color: var(--text3); font-weight: 500; font-family: 'JetBrains Mono', monospace; }
.timeline-controls { display: flex; align-items: center; gap: 4px; margin-top: 6px; }
.tl-btn {
  width: 22px; height: 22px; border-radius: 4px; border: 1px solid var(--border);
  background: var(--bg3); color: var(--text2); font-size: 10px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  padding: 0; font-family: inherit; transition: all 0.15s;
}
.tl-btn:hover { background: var(--bg4); color: var(--text); border-color: var(--border2); }
.tl-btn.playing { color: var(--blue); border-color: var(--blue); background: rgba(88,166,255,0.1); }
.timeline-slider {
  flex: 1;
  -webkit-appearance: none; appearance: none; width: 100%; height: 4px;
  background: var(--bg4); border-radius: 2px; outline: none; cursor: pointer;
}
.timeline-slider::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none; width: 14px; height: 14px;
  background: var(--blue); border-radius: 50%; cursor: pointer; border: 2px solid var(--bg);
  box-shadow: 0 0 4px rgba(88,166,255,0.4);
}
.timeline-slider::-moz-range-thumb {
  width: 14px; height: 14px; background: var(--blue); border-radius: 50%;
  cursor: pointer; border: 2px solid var(--bg);
}
.dataflow-wrap { flex: 1; overflow: auto; padding: 12px 16px; }
.pipeline-wrap {
  flex: 1; position: relative; overflow: auto; padding: 20px 24px 10px;
}
.pipeline-tables {
  display: flex; gap: 32px; justify-content: center; align-items: flex-start;
  position: relative; min-height: 120px;
}
.pipeline-svg {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 1;
}
.pipeline-svg path {
  fill: none; stroke-width: 2.5; stroke-linecap: round;
}
.join-line { stroke: var(--purple); opacity: 0.8; }
.join-line-anim {
  stroke-dasharray: 8 4; animation: dashFlow 1s linear infinite;
}
@keyframes dashFlow { to { stroke-dashoffset: -12; } }
.join-dot {
  fill: var(--purple); r: 4; opacity: 0.9;
}

/* Pipeline table cards */
.p-table {
  background: var(--bg2); border: 2px solid var(--border); border-radius: 10px;
  min-width: 150px; max-width: 220px; flex: 1; position: relative; z-index: 2;
  transition: all 0.3s;
}
.p-table.hl-from { border-color: var(--green); box-shadow: 0 0 16px rgba(63,185,80,0.15); }
.p-table.hl-join { border-color: var(--purple); box-shadow: 0 0 16px rgba(188,140,255,0.15); }
.p-table-name {
  padding: 7px 12px; font-size: 13px; font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg3); border-bottom: 1px solid var(--border);
  border-radius: 8px 8px 0 0; transition: all 0.3s; text-align: center;
}
.hl-from .p-table-name { background: rgba(63,185,80,0.12); color: var(--green); }
.hl-join .p-table-name { background: rgba(188,140,255,0.12); color: var(--purple); }
.p-table-cols { padding: 4px 0; }
.p-col {
  padding: 2px 12px; font-size: 11px; font-family: 'JetBrains Mono', monospace;
  color: var(--text2); transition: all 0.2s; border-left: 2px solid transparent;
  position: relative;
}
.p-col.hl-select { background: rgba(88,166,255,0.08); color: var(--blue); border-left-color: var(--blue); }
.p-col.hl-where { background: rgba(210,153,34,0.08); color: var(--yellow); border-left-color: var(--yellow); }
.p-col.hl-join-col { background: rgba(188,140,255,0.08); color: var(--purple); border-left-color: var(--purple); }
.p-col.hl-group { background: rgba(247,120,186,0.08); color: var(--pink); border-left-color: var(--pink); }
.p-col.hl-having { background: rgba(255,123,114,0.08); color: var(--red); border-left-color: var(--red); }
.p-col.hl-order { background: rgba(86,212,221,0.08); color: var(--cyan); border-left-color: var(--cyan); }
.p-col-pk { color: var(--orange); }

/* ===== EXECUTION FLOW ===== */
.flow-bar {
  display: flex; gap: 4px; padding: 10px 24px; align-items: center;
  flex-shrink: 0; flex-wrap: wrap; background: var(--bg2);
  border-top: 1px solid var(--border);
}
.flow-label { font-size: 10px; color: var(--text3); margin-right: 4px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
.flow-arrow { color: var(--text3); font-size: 10px; margin: 0 2px; }
.flow-step {
  padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
  background: var(--bg3); color: var(--text3); border: 1px solid var(--border);
  transition: all 0.3s; cursor: pointer; position: relative;
}
.flow-step.active { border-color: currentColor; }
.flow-step.s-from.active { color: var(--green); background: rgba(63,185,80,0.1); }
.flow-step.s-join.active { color: var(--purple); background: rgba(188,140,255,0.1); }
.flow-step.s-where.active { color: var(--yellow); background: rgba(210,153,34,0.1); }
.flow-step.s-group.active { color: var(--pink); background: rgba(247,120,186,0.1); }
.flow-step.s-having.active { color: var(--red); background: rgba(255,123,114,0.1); }
.flow-step.s-select.active { color: var(--blue); background: rgba(88,166,255,0.1); }
.flow-step.s-order.active { color: var(--cyan); background: rgba(86,212,221,0.1); }

/* Step tooltip */
.flow-tooltip {
  display: none; position: absolute; bottom: calc(100% + 8px); left: 50%;
  transform: translateX(-50%); background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; padding: 8px 12px; font-size: 11px; font-weight: 400;
  color: var(--text); white-space: nowrap; z-index: 100;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4); line-height: 1.4;
}
.flow-tooltip::after {
  content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%);
  border:5px solid transparent; border-top-color:var(--border);
}
.flow-step.show-tip .flow-tooltip { display: block; }

/* ===== RESULTS ===== */
.results-section {
  flex: 65; min-height: 80px;
  display: flex; flex-direction: column; overflow: hidden;
}
.results-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 6px 16px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.results-header-title { font-size: 11px; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.results-status { font-size: 11px; color: var(--text3); display: flex; gap: 12px; }
.results-status span { display: flex; align-items: center; gap: 4px; }
.results-wrap { flex: 1; overflow: auto; }
.results-table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: 'JetBrains Mono', monospace; }
.results-table th {
  padding: 6px 12px; text-align: left; font-weight: 600;
  background: var(--bg3); border-bottom: 2px solid var(--border);
  color: var(--blue); position: sticky; top: 0; z-index: 1; white-space: nowrap;
}
.results-table td { padding: 5px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
.results-table tbody tr:hover { background: var(--bg3); }
.results-table .cell-null { color: var(--text3); font-style: italic; }
.results-table .cell-number { color: var(--lightred); }
.results-table .cell-string { color: var(--text); }
.results-table .row-animate { animation: rowFadeIn 0.3s ease forwards; opacity: 0; }
@keyframes rowFadeIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }
.results-error { padding: 16px; color: var(--red); font-size: 12px; font-family: 'JetBrains Mono', monospace; line-height: 1.5; background: rgba(255,123,114,0.05); border-radius: 8px; margin: 12px; }
.results-empty { padding: 30px; text-align: center; color: var(--text3); font-size: 12px; }
.results-empty kbd { background: var(--bg3); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 10px; }

/* ===== EXAMPLES ===== */
.examples-dropdown { position: relative; display: inline-block; }
.examples-menu {
  display: none; position: absolute; top: calc(100% + 4px); right: 0;
  background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
  min-width: 380px; max-height: 380px; overflow: auto; z-index: 200;
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
}
.examples-menu.show { display: block; }
.example-item {
  padding: 7px 12px; cursor: pointer; font-size: 11px;
  border-bottom: 1px solid var(--border); transition: background 0.1s;
  display: flex; gap: 6px; align-items: flex-start;
}
.example-item:last-child { border-bottom: none; }
.example-item:hover { background: var(--bg4); }
.example-num { color: var(--text3); font-weight: 600; font-size: 10px; min-width: 18px; font-family: 'JetBrains Mono', monospace; }
.example-info { flex: 1; }
.example-name { color: var(--text); font-weight: 500; margin-bottom: 1px; font-size: 11px; }
.example-sql { color: var(--text3); font-size: 10px; font-family: 'JetBrains Mono', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 320px; }

/* ===== DATA FLOW ===== */
#dataFlow { padding: 0; }
#dataFlow:empty { display: none; }
.df-card {
  margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--border);
  background: var(--bg2); overflow: hidden;
}
.df-card-header {
  display: flex; align-items: center; gap: 8px; padding: 6px 12px;
  font-size: 10px; font-weight: 600; border-bottom: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace; line-height: 1.4;
}
.df-card-header > span:nth-child(2) { flex: 1; min-width: 0; word-break: break-word; }
.df-card-header .df-step-num {
  width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center;
  justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0;
}
.df-card-header .df-count {
  margin-left: auto; font-weight: 400; color: var(--text3); font-size: 10px;
}
.df-card-body { display: flex; gap: 6px; padding: 6px; }
.df-card-body.df-single { display: block; }
.df-half { flex: 1; min-width: 0; }
.df-half-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text3); margin-bottom: 4px; padding: 0 4px; }
.df-mini-table { width: 100%; border-collapse: collapse; font-size: 10px; font-family: 'JetBrains Mono', monospace; }
.df-mini-table th { padding: 2px 5px; text-align: left; font-weight: 600; color: var(--text2); border-bottom: 1px solid var(--border); white-space: nowrap; font-size: 9px; }
.df-mini-table td { padding: 2px 5px; white-space: nowrap; color: var(--text2); border-bottom: 1px solid rgba(48,54,61,0.5); }
.df-mini-table tr.df-pass td { color: var(--green); }
.df-mini-table tr.df-fail td { color: var(--text3); text-decoration: line-through; opacity: 0.6; }
.df-mini-table .df-null { color: var(--text3); font-style: italic; }
.df-mini-table .df-more { color: var(--text3); font-style: italic; font-size: 9px; }
.df-mini-table .df-new-col { color: var(--purple); }
.df-arrow { text-align: center; color: var(--text3); font-size: 14px; padding: 4px 0; }
/* Step colors */
.df-from .df-step-num { background: rgba(63,185,80,0.2); color: var(--green); }
.df-from .df-card-header { color: var(--green); }
.df-join .df-step-num { background: rgba(188,140,255,0.2); color: var(--purple); }
.df-join .df-card-header { color: var(--purple); }
.df-where .df-step-num { background: rgba(210,153,34,0.2); color: var(--yellow); }
.df-where .df-card-header { color: var(--yellow); }
.df-group .df-step-num { background: rgba(247,120,186,0.2); color: var(--pink); }
.df-group .df-card-header { color: var(--pink); }
.df-having .df-step-num { background: rgba(255,123,114,0.2); color: var(--red); }
.df-having .df-card-header { color: var(--red); }
.df-select .df-step-num { background: rgba(88,166,255,0.2); color: var(--blue); }
.df-select .df-card-header { color: var(--blue); }
.df-order .df-step-num { background: rgba(86,212,221,0.2); color: var(--cyan); }
.df-order .df-card-header { color: var(--cyan); }
.df-setop .df-step-num { background: rgba(210,153,34,0.2); color: var(--yellow); }
.df-setop .df-card-header { color: var(--yellow); }
.df-case .df-step-num { background: rgba(188,140,255,0.2); color: var(--purple); }
.df-case .df-card-header { color: var(--purple); }
.df-case-table { width: 100%; border-collapse: collapse; font-size: 10px; font-family: 'JetBrains Mono', monospace; }
.df-case-table th { padding: 2px 5px; text-align: left; font-weight: 600; color: var(--text2); border-bottom: 1px solid var(--border); white-space: nowrap; font-size: 9px; }
.df-case-table td { padding: 2px 5px; white-space: nowrap; color: var(--text2); border-bottom: 1px solid rgba(48,54,61,0.5); }
.df-case-table tr.df-case-match td { color: var(--green); }
.df-case-table tr.df-case-skip td { color: var(--text3); opacity: 0.5; }
.df-case-table .df-case-result { font-weight: 600; }
.df-setop-parts { display: flex; flex-direction: column; gap: 8px; padding: 6px; }
.df-setop-part { border: 1px solid var(--border); border-radius: 4px; padding: 4px; }
.df-setop-part-label { font-size: 9px; font-weight: 600; color: var(--text3); margin-bottom: 4px; padding: 0 4px; }

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border2); }

/* ===== RESIZE ===== */
.resize-h {
  height: 4px; cursor: row-resize; background: transparent; flex-shrink: 0;
  transition: background 0.15s; z-index: 10;
}
.resize-h:hover, .resize-h.dragging { background: var(--blue); }
.resize-v {
  width: 4px; cursor: col-resize; background: transparent; flex-shrink: 0;
  transition: background 0.15s; z-index: 10;
}
.resize-v:hover, .resize-v.dragging { background: var(--blue); }

/* ===== CHALLENGE MODE ===== */
.btn-challenge { background: rgba(210,153,34,0.15); border-color: var(--yellow); color: var(--yellow); }
.btn-challenge:hover { background: rgba(210,153,34,0.3); }
.btn-challenge.active { background: var(--yellow); color: var(--bg); }

.challenge-panel {
  background: var(--bg2); border-bottom: 2px solid var(--yellow);
  padding: 12px 16px; flex-shrink: 0;
  animation: ch-slide 0.2s ease-out;
}
@keyframes ch-slide { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
.challenge-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.challenge-tag {
  font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
  color: var(--yellow); background: rgba(210,153,34,0.15); padding: 2px 8px; border-radius: 4px;
}
.challenge-close {
  background: none; border: none; color: var(--text3); cursor: pointer; font-size: 14px; padding: 2px 6px;
}
.challenge-close:hover { color: var(--text); }
.challenge-from { font-size: 11px; color: var(--yellow); font-weight: 600; margin-bottom: 6px; }
.challenge-body { font-size: 12px; color: var(--text); line-height: 1.6; margin-bottom: 8px; }
.challenge-hint { font-size: 10px; color: var(--text3); font-style: italic; }
.challenge-nav {
  display: flex; align-items: center; justify-content: space-between; margin-top: 10px;
  padding-top: 8px; border-top: 1px solid var(--border);
}
.ch-nav-btn {
  background: var(--bg3); border: 1px solid var(--border); color: var(--text2);
  padding: 3px 10px; border-radius: 4px; font-size: 10px; cursor: pointer; font-family: 'Inter', sans-serif;
}
.ch-nav-btn:hover { background: var(--bg4); color: var(--text); }
.ch-nav-btn:disabled { opacity: 0.3; cursor: default; }
.challenge-counter { font-size: 10px; color: var(--text3); }
.challenge-done { color: var(--green); font-size: 10px; margin-left: 6px; }

.challenge-result {
  margin-top: 8px; padding: 8px 12px; border-radius: 6px; text-align: center;
  font-weight: 600; font-size: 12px; font-family: 'Inter', sans-serif;
  animation: ch-slide 0.2s ease-out;
}
.challenge-result.success { background: rgba(63,185,80,0.15); color: var(--green); border: 1px solid rgba(63,185,80,0.4); }
.challenge-result.fail { background: rgba(255,123,114,0.1); color: var(--red); border: 1px solid rgba(255,123,114,0.3); }

@keyframes ch-shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
.challenge-result.fail { animation: ch-shake 0.3s ease-out; }

.challenge-flash { position: fixed; inset: 0; pointer-events: none; z-index: 9999; animation: ch-flash 0.7s forwards; }
@keyframes ch-flash { 0% { background: rgba(63,185,80,0.25); } 100% { background: rgba(63,185,80,0); } }

.confetti-piece {
  position: fixed; width: 8px; height: 8px; top: -10px; z-index: 10000;
  border-radius: 2px; pointer-events: none;
  animation: confetti-fall 1.8s ease-in forwards;
}
@keyframes confetti-fall {
  0% { transform: translateY(0) rotate(0deg); opacity: 1; }
  100% { transform: translateY(105vh) rotate(720deg); opacity: 0; }
}

/* ===== DICTIONARY PANEL ===== */
.btn-dict { background: rgba(86,212,221,0.15); border-color: var(--cyan); color: var(--cyan); }
.btn-dict:hover { background: rgba(86,212,221,0.3); }
.btn-dict.active { background: var(--cyan); color: var(--bg); }

.dict-panel {
  position: absolute; top: 0; right: 0; bottom: 0; width: 400px;
  background: var(--bg2); border-left: 2px solid var(--cyan); z-index: 30;
  display: flex; flex-direction: column; animation: dict-slide 0.2s ease-out;
}
@keyframes dict-slide { from { transform: translateX(100%); } to { transform: translateX(0); } }
.dict-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.dict-header-title { font-size: 12px; font-weight: 700; color: var(--cyan); text-transform: uppercase; letter-spacing: 0.5px; }
.dict-close { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 14px; padding: 2px 6px; }
.dict-close:hover { color: var(--text); }
.dict-list { flex: 1; overflow-y: auto; padding: 8px 0; }
.dict-item { padding: 8px 14px; border-bottom: 1px solid rgba(48,54,61,0.5); }
.dict-item:hover { background: var(--bg3); }
.dict-kw { display: flex; align-items: center; gap: 8px; margin-bottom: 3px; }
.dict-tag {
  font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace;
  padding: 1px 6px; border-radius: 3px; white-space: nowrap;
}
.dict-tag-blue { background: rgba(88,166,255,0.15); color: var(--blue); }
.dict-tag-green { background: rgba(63,185,80,0.15); color: var(--green); }
.dict-tag-yellow { background: rgba(210,153,34,0.15); color: var(--yellow); }
.dict-tag-purple { background: rgba(188,140,255,0.15); color: var(--purple); }
.dict-tag-orange { background: rgba(240,136,62,0.15); color: var(--orange); }
.dict-tag-pink { background: rgba(247,120,186,0.15); color: var(--pink); }
.dict-tag-cyan { background: rgba(86,212,221,0.15); color: var(--cyan); }
.dict-tag-red { background: rgba(255,123,114,0.15); color: var(--red); }
.dict-desc { font-size: 11px; color: var(--text2); line-height: 1.4; }
.dict-example { font-size: 10px; color: var(--text3); font-family: 'JetBrains Mono', monospace; margin-top: 3px; }

/* ===== WORKBOOK / PR≈ÆVODCE CVIƒåEN√çM ===== */
.workbook-panel {
  position: absolute; top: 0; right: 0; bottom: 0; width: 400px;
  background: var(--bg2); border-left: 2px solid var(--green); z-index: 40;
  display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.5);
  animation: wb-slide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes wb-slide { from { transform: translateX(100%); } to { transform: translateX(0); } }

.workbook-header {
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.workbook-header-title { font-size: 12px; font-weight: 700; color: var(--green); text-transform: uppercase; letter-spacing: 0.5px; }

.workbook-content { flex: 1; overflow-y: auto; padding: 12px; }

.workbook-chapter {
  font-size: 11px; font-weight: 700; color: var(--text3);
  margin: 16px 0 8px 0; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 4px;
}
.workbook-item {
  padding: 10px 12px; border-radius: 8px; margin-bottom: 6px;
  background: var(--bg3); border: 1px solid var(--border);
  font-size: 12px; line-height: 1.5; cursor: pointer;
  transition: all 0.2s; position: relative;
}
.workbook-item:hover { border-color: var(--border2); background: var(--bg4); }

/* Aktivn√≠ √∫kol (vybran√Ω u≈æivatelem) - MODR√Å */
.workbook-item.active {
  border-left: 3px solid var(--blue);
  background: var(--bg4);
  box-shadow: 0 0 10px rgba(88,166,255,0.1);
}

/* Splnƒõn√Ω √∫kol - ZELEN√Å */
.workbook-item.solved {
  border-color: rgba(63,185,80,0.5); 
  background: rgba(63,185,80,0.08); 
}
.workbook-item.solved::after {
  content: '‚úì'; position: absolute; right: 10px; top: 10px; color: var(--green); font-weight: 700;
}
.workbook-item .q-num { font-weight: 700; color: var(--blue); margin-right: 6px; }

.hidden { display: none !important; }


/* ===== MOBILE ===== */
@media (max-width: 768px) {
  body { overflow: auto; }
  .app { height: auto; min-height: 100vh; }
  .main-content { flex-direction: column; overflow: visible; }
  .col-left, .col-right { display: contents; }
  .resize-v, .resize-h { display: none !important; }

  .editor-section { order: 1; flex: none !important; height: 200px; border-bottom: 2px solid var(--border2); }
  .results-section { order: 2; flex: none !important; border-bottom: 2px solid var(--border2); }
  .dataflow-section { order: 3; flex: none !important; border-bottom: 2px solid var(--border2); }
  .pipeline-section { order: 4; flex: none !important; }

  .results-wrap { max-height: 50vh; }
  .dataflow-wrap { max-height: none; overflow: visible; }
  .pipeline-wrap { overflow: visible; padding: 12px; }
  .pipeline-tables { flex-direction: column; align-items: stretch; gap: 24px; }
  .p-table { max-width: none; min-width: 0; }

  .header { padding: 6px 12px; }
  .header h1 { font-size: 13px; }
  .editor-toolbar { flex-wrap: wrap; gap: 6px; padding: 6px 10px; }
  .editor-toolbar-right { flex-wrap: wrap; }
  .btn { font-size: 10px; padding: 4px 8px; }
  .btn kbd { display: none; }

  .examples-dropdown { position: static; }
  .examples-menu {
    position: fixed; top: auto; bottom: 0; left: 8px; right: 8px;
    min-width: 0; max-height: 60vh; border-radius: 12px 12px 0 0;
    box-shadow: 0 -8px 32px rgba(0,0,0,0.6);
  }
  .example-sql { white-space: normal; overflow: visible; max-width: none; font-size: 9px; }

  .editor-textarea { font-size: 16px; }
  .editor-highlight { font-size: 16px; }
  .editor-line-numbers { font-size: 16px; }

  .flow-bar { padding: 8px 12px; flex-wrap: wrap; }

  .pipeline-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
  .pipeline-tables { position: relative; }

  .challenge-panel { padding: 10px 12px; }
  .challenge-body { font-size: 11px; }
  .ch-nav-btn { font-size: 9px; padding: 3px 8px; }

  .dict-panel { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; border-left: none; border-top: 2px solid var(--cyan); }
  .workbook-panel { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; border-left: none; border-top: 2px solid var(--green); }
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1><span>SQL</span> Vizualiz√©r</h1>
    <div style="display:flex;align-items:center;gap:8px">
      <span style="font-size:11px;color:var(--text3)">4IT218 ‚Äî Oracle SQL</span>
      
      <input type="file" id="workbookFile" class="hidden" accept=".txt,.ini,.text">
      <button class="btn btn-success" onclick="document.getElementById('workbookFile').click()">üìÇ Nahr√°t cviƒçen√≠</button>
      
      <button class="btn btn-dict" id="btnDict" onclick="toggleDict()">Slovn√≠k</button>
    </div>
  </div>

  <div class="main-content">
    <div class="col-left" id="colLeft">
      <div class="editor-section" id="editorSection">
        <div class="editor-toolbar">
          <div class="editor-toolbar-left">
            <span class="editor-toolbar-title">SQL Editor</span>
          </div>
          <div class="editor-toolbar-right">
            <div class="examples-dropdown">
              <button class="btn" id="btnExamples" onclick="toggleExamples()">P≈ô√≠klady ‚ñæ</button>
              <div class="examples-menu" id="examplesMenu"></div>
            </div>
            <button class="btn btn-challenge" id="btnChallenge" onclick="toggleChallenge()">Challenge</button>
            <button class="btn btn-primary" id="btnRun" onclick="executeQuery()">‚ñ∂ Spustit <kbd>Ctrl+Enter</kbd></button>
          </div>
        </div>
        <div class="editor-wrap" id="editorWrap">
          <div class="editor-line-numbers" id="lineNumbers">1</div>
          <div class="editor-highlight" id="editorHighlight"></div>
          <textarea class="editor-textarea" id="editorTextarea" spellcheck="false" placeholder="Napi≈° SQL dotaz..."></textarea>
        </div>
        <div class="clause-warning" id="clauseWarning"></div>
      </div>
      <div class="challenge-panel" id="challengePanel" style="display:none">
        <div class="challenge-card">
          <div class="challenge-header">
            <span class="challenge-tag" id="challengeTag">CHALLENGE #1</span>
            <button class="challenge-close" onclick="closeChallenge()" title="Zav≈ô√≠t">‚úï</button>
          </div>
          <div class="challenge-from" id="challengeFrom"></div>
          <div class="challenge-body" id="challengeBody"></div>
          <div class="challenge-hint" id="challengeHint"></div>
          <div class="challenge-nav">
            <button class="ch-nav-btn" id="chPrev" onclick="prevChallenge()">‚Üê P≈ôedchoz√≠</button>
            <span class="challenge-counter" id="challengeCounter"></span>
            <button class="ch-nav-btn" id="chNext" onclick="nextChallenge()">Dal≈°√≠ ‚Üí</button>
          </div>
        </div>
        <div class="challenge-result" id="challengeResult" style="display:none"></div>
      </div>
      <div class="resize-h" id="resizeEditorFlow"></div>
      <div class="dataflow-section" id="dataflowSection">
        <div class="dataflow-header">
          <div class="timeline-top">
            <span class="timeline-title">Pr≈Øbƒõh zpracov√°n√≠</span>
            <span class="timeline-step-label" id="timelineLabel"></span>
          </div>
          <div class="timeline-controls" id="timelineControls" style="display:none">
            <button class="tl-btn" id="tlPrev" title="P≈ôedchoz√≠ krok">‚óÄ</button>
            <button class="tl-btn" id="tlPlay" title="P≈ôehr√°t/Pozastavit">‚ñ∂</button>
            <button class="tl-btn" id="tlNext" title="Dal≈°√≠ krok">‚ñ∂</button>
            <input type="range" class="timeline-slider" id="timelineSlider" min="0" max="0" value="0">
          </div>
        </div>
        <div class="dataflow-wrap" id="dataFlow"></div>
      </div>
    </div>

    <div class="resize-v" id="resizeColumns"></div>

    <div class="col-right" id="colRight">
      
      <div id="workbookPanel" class="workbook-panel hidden">
        <div class="workbook-header">
          <span class="workbook-header-title">Pr≈Øvodce cviƒçen√≠m</span>
          <button class="btn" onclick="toggleWorkbook()">‚úï</button>
        </div>
        <div class="workbook-content" id="workbookContent">
          <p style="color:var(--text3); font-size:11px; padding:10px;">Nahraj soubor se zad√°n√≠m...</p>
        </div>
      </div>

      <div class="dict-panel" id="dictPanel" style="display:none">
        <div class="dict-header">
          <span class="dict-header-title">SQL Slovn√≠k</span>
          <button class="dict-close" onclick="toggleDict()" title="Zav≈ô√≠t">‚úï</button>
        </div>
        <div class="dict-list" id="dictList"></div>
      </div>
      <div class="pipeline-section" id="pipelineSection">
        <div class="pipeline-header"><span class="pipeline-header-title">Vizualizace tabulek</span></div>
        <div class="pipeline-wrap" id="pipelineWrap">
          <div class="pipeline-tables" id="pipelineTables">
            <svg class="pipeline-svg" id="pipelineSvg"></svg>
          </div>
        </div>
        <div class="flow-bar" id="flowBar">
          <span class="flow-label">Po≈ôad√≠ vykon√°n√≠:</span>
        </div>
      </div>
      <div class="resize-h" id="resizePipelineResults"></div>
      <div class="results-section" id="resultsSection">
        <div class="results-header">
          <span class="results-header-title">V√Ωsledky</span>
          <div class="results-status" id="resultsStatus"></div>
        </div>
        <div class="results-wrap" id="resultsWrap">
          <div class="results-empty" id="resultsPlaceholder">Napi≈° SQL dotaz a stiskni <kbd>Ctrl+Enter</kbd> pro spu≈°tƒõn√≠</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Timeline state (declared early so updatePipeline can reference)
var timelineSteps = [];
var timelinePos = 0;

// ============================================================
// DATABASE DATA
// ============================================================
const DB = {
  ODDEL: {
    columns: ['CIS_ODD','NAZEV','SEF'],
    pk: 'CIS_ODD',
    rows: [
      {CIS_ODD:1, NAZEV:'PROJEKCE', SEF:6},
      {CIS_ODD:2, NAZEV:'KNIHOVNA', SEF:12},
      {CIS_ODD:3, NAZEV:'PROGRAMOVANI', SEF:20},
      {CIS_ODD:4, NAZEV:'BUFET', SEF:31},
      {CIS_ODD:6, NAZEV:'SKLAD', SEF:41},
      {CIS_ODD:7, NAZEV:'STB', SEF:null},
      {CIS_ODD:8, NAZEV:'PROVOZ POCITACE', SEF:51},
      {CIS_ODD:10, NAZEV:'REDITELSTVI', SEF:77},
    ]
  },
  ZAM: {
    columns: ['OS_CIS','JMENO','FCE','PLAT','TITUL','CIS_ODD','NADR'],
    pk: 'OS_CIS',
    rows: [
      {OS_CIS:1, JMENO:'KONADRA', FCE:'POSLICEK', PLAT:5400, TITUL:null, CIS_ODD:1, NADR:6},
      {OS_CIS:2, JMENO:'SYKORA', FCE:'BESTBOY', PLAT:6000, TITUL:null, CIS_ODD:1, NADR:6},
      {OS_CIS:3, JMENO:'STRNAD', FCE:'SVACINAR', PLAT:7500, TITUL:null, CIS_ODD:1, NADR:6},
      {OS_CIS:4, JMENO:'KOS', FCE:'PROJEKTANT', PLAT:10500, TITUL:'ING', CIS_ODD:1, NADR:6},
      {OS_CIS:5, JMENO:'KOS', FCE:'PROJEKTANT', PLAT:10800, TITUL:'ING', CIS_ODD:1, NADR:6},
      {OS_CIS:6, JMENO:'VOREL', FCE:'BOSS', PLAT:12000, TITUL:'ING', CIS_ODD:1, NADR:7},
      {OS_CIS:7, JMENO:'DATEL', FCE:'BOSS', PLAT:12600, TITUL:'RNDR', CIS_ODD:1, NADR:77},
      {OS_CIS:8, JMENO:'MALY', FCE:'POSLICEK', PLAT:6000, TITUL:null, CIS_ODD:2, NADR:11},
      {OS_CIS:9, JMENO:'DLOUHY', FCE:'KNIHOVNIK', PLAT:9000, TITUL:null, CIS_ODD:2, NADR:11},
      {OS_CIS:10, JMENO:'VYSOKY', FCE:'KNIHOVNIK', PLAT:10500, TITUL:null, CIS_ODD:2, NADR:11},
      {OS_CIS:11, JMENO:'TLUSTY', FCE:'KNIHOVNIK', PLAT:11100, TITUL:'ING', CIS_ODD:2, NADR:13},
      {OS_CIS:12, JMENO:'TLUSTY', FCE:'SVACINAR', PLAT:6000, TITUL:null, CIS_ODD:2, NADR:13},
      {OS_CIS:13, JMENO:'OTYLY', FCE:'BOSS', PLAT:12000, TITUL:'ING', CIS_ODD:2, NADR:14},
      {OS_CIS:14, JMENO:'OBROVSKY', FCE:'BOSS', PLAT:13500, TITUL:'RNDR', CIS_ODD:2, NADR:77},
      {OS_CIS:15, JMENO:'CERNY', FCE:'PROGRAMATOR', PLAT:7500, TITUL:null, CIS_ODD:3, NADR:21},
      {OS_CIS:16, JMENO:'CERVENY', FCE:'PROGRAMATOR', PLAT:9000, TITUL:null, CIS_ODD:3, NADR:21},
      {OS_CIS:17, JMENO:'ZELENY', FCE:'PROGRAMATOR', PLAT:10500, TITUL:'ING', CIS_ODD:3, NADR:21},
      {OS_CIS:18, JMENO:'ZELENY', FCE:'PROGRAMATOR', PLAT:10500, TITUL:'ING', CIS_ODD:3, NADR:21},
      {OS_CIS:19, JMENO:'FIALKA', FCE:'PROGRAMATOR', PLAT:10500, TITUL:'ING', CIS_ODD:3, NADR:21},
      {OS_CIS:20, JMENO:'FIALOVA', FCE:'PROGRAMATOR', PLAT:10200, TITUL:'RNDR', CIS_ODD:3, NADR:21},
      {OS_CIS:21, JMENO:'ZLATUSKA', FCE:'BOSS', PLAT:13500, TITUL:'RNDR', CIS_ODD:3, NADR:77},
      {OS_CIS:31, JMENO:'SEBESTOVA', FCE:'BOSS', PLAT:8400, TITUL:null, CIS_ODD:4, NADR:77},
      {OS_CIS:32, JMENO:'MACHOVA', FCE:'BUFETACKA', PLAT:7500, TITUL:null, CIS_ODD:4, NADR:31},
      {OS_CIS:33, JMENO:'HORACKOVA', FCE:'UKLIZECKA', PLAT:7500, TITUL:null, CIS_ODD:4, NADR:31},
      {OS_CIS:34, JMENO:'HORACKOVA', FCE:'BUFETACKA', PLAT:7800, TITUL:null, CIS_ODD:4, NADR:31},
      {OS_CIS:35, JMENO:'PAZOUTOVA', FCE:'MYCKA NADOBI', PLAT:6600, TITUL:null, CIS_ODD:4, NADR:31},
      {OS_CIS:36, JMENO:'KADRNOZKOVA', FCE:'MYCKA NADOBI', PLAT:6600, TITUL:null, CIS_ODD:4, NADR:31},
      {OS_CIS:37, JMENO:'JONATANOVA', FCE:'UKLIZECKA', PLAT:6600, TITUL:null, CIS_ODD:4, NADR:31},
      {OS_CIS:41, JMENO:'CECH', FCE:'BOSS', PLAT:9000, TITUL:'ING', CIS_ODD:6, NADR:77},
      {OS_CIS:42, JMENO:'SLOVAK', FCE:'SKLADNIK', PLAT:6600, TITUL:null, CIS_ODD:6, NADR:41},
      {OS_CIS:43, JMENO:'NEMEC', FCE:'SKLADNIK', PLAT:7200, TITUL:null, CIS_ODD:6, NADR:41},
      {OS_CIS:44, JMENO:'CECH', FCE:'SKLADNIK', PLAT:7500, TITUL:null, CIS_ODD:6, NADR:41},
      {OS_CIS:51, JMENO:'KOCOUR', FCE:'BOSS', PLAT:12900, TITUL:'DOC', CIS_ODD:8, NADR:77},
      {OS_CIS:52, JMENO:'KOCOUR', FCE:'SEF TECHNIK', PLAT:11400, TITUL:'ING', CIS_ODD:8, NADR:51},
      {OS_CIS:53, JMENO:'KOBYLKA', FCE:'TECHNIK', PLAT:10500, TITUL:'ING', CIS_ODD:8, NADR:52},
      {OS_CIS:54, JMENO:'KOCICKA', FCE:'TECHNIK', PLAT:10200, TITUL:null, CIS_ODD:8, NADR:52},
      {OS_CIS:55, JMENO:'PAPOUSEK', FCE:'TECHNIK', PLAT:10200, TITUL:null, CIS_ODD:8, NADR:52},
      {OS_CIS:77, JMENO:'SEFICEK', FCE:'REDITEL', PLAT:15000, TITUL:'DOC', CIS_ODD:10, NADR:null},
    ]
  },
  UKOLY: {
    columns: ['CIS_UK','POPIS','OS_CIS','DATUM'],
    pk: 'CIS_UK',
    rows: [
      {CIS_UK:101, POPIS:'PRINEST POSTU', OS_CIS:1, DATUM:'10/02/15'},
      {CIS_UK:102, POPIS:'ZAPLATIT SLOZENKY', OS_CIS:1, DATUM:'02/10/15'},
      {CIS_UK:105, POPIS:'POSTAVIT PODRIZENE DO LATE', OS_CIS:21, DATUM:'10/02/15'},
      {CIS_UK:106, POPIS:'ROZDELIT PRACI NA PROJEKTU FIS', OS_CIS:21, DATUM:'02/10/15'},
      {CIS_UK:107, POPIS:'ROZDELIT PRACI NA PROJEKTU KIS', OS_CIS:7, DATUM:'02/09/15'},
      {CIS_UK:108, POPIS:'DOJIT PRO SALAM A PIVKO', OS_CIS:3, DATUM:'02/11/15'},
      {CIS_UK:109, POPIS:'SEHNAT NECO NA ZUB', OS_CIS:12, DATUM:'15/10/15'},
      {CIS_UK:110, POPIS:'ZARADIT NOVE TITULY', OS_CIS:10, DATUM:'22/12/15'},
      {CIS_UK:111, POPIS:'DOKONCIT PROGRAM X57', OS_CIS:19, DATUM:'02/01/15'},
      {CIS_UK:112, POPIS:'ODLADIT ROZDELANE PROGRAMY', OS_CIS:20, DATUM:'02/12/15'},
      {CIS_UK:113, POPIS:'ZDOKUMENTOVAT PROGRAMY', OS_CIS:19, DATUM:'02/12/15'},
      {CIS_UK:114, POPIS:'PROVEST INVENTURU SKLADU C.13', OS_CIS:42, DATUM:'02/06/15'},
      {CIS_UK:115, POPIS:'KONECNE UKLIDIT', OS_CIS:37, DATUM:'10/07/15'},
      {CIS_UK:120, POPIS:'SEHNAT NOVE LIDI DO TYMU', OS_CIS:7, DATUM:'30/10/15'},
    ]
  },
  DUAL: {
    columns: ['DUMMY'],
    pk: null,
    rows: [{DUMMY: 'X'}]
  }
};

// ============================================================
// SQL TOKENIZER
// ============================================================
const TOKEN_PATTERNS = [
  { type: 'comment_line', regex: /--[^\n]*/ },
  { type: 'comment_block', regex: /\/\*[\s\S]*?\*\// },
  { type: 'string', regex: /'(?:[^']|'')*'/ },
  { type: 'dqstring', regex: /"(?:[^"]|"")*"/ },
  { type: 'number', regex: /\b\d+(?:\.\d+)?\b/ },
  { type: 'concat', regex: /\|\|/ },
  { type: 'op', regex: /[<>!=]=?|[+\-\/]/ },
  { type: 'paren_open', regex: /\(/ },
  { type: 'paren_close', regex: /\)/ },
  { type: 'comma', regex: /,/ },
  { type: 'dot', regex: /\./ },
  { type: 'star', regex: /\*/ },
  { type: 'word', regex: /[A-Za-z_ƒå≈†≈Ω√Å√â√ç√ì√ö≈Æ√ù≈ò≈§ƒé≈áƒç≈°≈æ√°√©√≠√≥√∫≈Ø√Ω≈ô≈•ƒè≈à][A-Za-z0-9_ƒå≈†≈Ω√Å√â√ç√ì√ö≈Æ√ù≈ò≈§ƒé≈áƒç≈°≈æ√°√©√≠√≥√∫≈Ø√Ω≈ô≈•ƒè≈à]*/ },
  { type: 'ws', regex: /\s+/ },
];

function tokenize(sql) {
  const tokens = [];
  let pos = 0;
  while (pos < sql.length) {
    let matched = false;
    for (const pat of TOKEN_PATTERNS) {
      const m = sql.slice(pos).match(new RegExp('^(' + pat.regex.source + ')'));
      if (m) { tokens.push({ type: pat.type, value: m[1], pos }); pos += m[1].length; matched = true; break; }
    }
    if (!matched) { tokens.push({ type: 'unknown', value: sql[pos], pos }); pos++; }
  }
  return tokens;
}

// ============================================================
// SYNTAX HIGHLIGHTER
// ============================================================
const SELECT_KW = new Set(['SELECT','DISTINCT']);
const FROM_KW = new Set(['FROM']);
const WHERE_KW = new Set(['WHERE','AND','OR','NOT','IN','BETWEEN','LIKE','IS','NULL','EXISTS']);
const JOIN_KW = new Set(['JOIN','INNER','LEFT','RIGHT','FULL','OUTER','CROSS','ON','USING','NATURAL']);
const AGG_FN = new Set(['COUNT','SUM','AVG','MAX','MIN']);
const SCALAR_FN = new Set(['ROUND','UPPER','LOWER','LENGTH','SUBSTR','TRIM','ABS','NVL','NVL2','NULLIF','COALESCE','MOD','CEIL','FLOOR','TRUNC','REPLACE','LPAD','RPAD','INSTR','INITCAP','TO_CHAR','TO_NUMBER','DECODE','GREATEST','LEAST','SIGN','POWER','SQRT']);

function highlightSQL(sql) {
  const tokens = tokenize(sql);
  let html = '', clause = '', parenDepth = 0, subqueryStack = [];
  for (let i = 0; i < tokens.length; i++) {
    const t = tokens[i], esc = escapeHTML(t.value);
    if (t.type === 'comment_line' || t.type === 'comment_block') { html += `<span class="syn-comment">${esc}</span>`; continue; }
    if (t.type === 'string' || t.type === 'dqstring') { html += `<span class="syn-string">${esc}</span>`; continue; }
    if (t.type === 'number') { html += `<span class="syn-number">${esc}</span>`; continue; }
    if (t.type === 'ws') { html += esc; continue; }
    if (t.type === 'comma') { html += `<span class="syn-comma">${esc}</span>`; continue; }
    if (t.type === 'dot') { html += `<span class="syn-dot">${esc}</span>`; continue; }
    if (t.type === 'paren_open') {
      parenDepth++;
      let j = i + 1; while (j < tokens.length && tokens[j].type === 'ws') j++;
      if (j < tokens.length && tokens[j].type === 'word' && tokens[j].value.toUpperCase() === 'SELECT') subqueryStack.push(clause);
      html += `<span class="syn-paren">${esc}</span>`; continue;
    }
    if (t.type === 'paren_close') {
      parenDepth--;
      if (subqueryStack.length > 0 && parenDepth < subqueryStack.length) clause = subqueryStack.pop() || '';
      html += `<span class="syn-paren">${esc}</span>`; continue;
    }
    if (t.type === 'concat' || t.type === 'op') { html += `<span class="syn-operator">${esc}</span>`; continue; }
    if (t.type === 'star') { html += `<span class="syn-star">${esc}</span>`; continue; }
    if (t.type === 'word') {
      const w = t.value.toUpperCase();
      if (w === 'SELECT' || w === 'DISTINCT') { clause = 'select'; html += `<span class="syn-select">${esc}</span>`; continue; }
      if (w === 'FROM') { clause = 'from'; html += `<span class="syn-from">${esc}</span>`; continue; }
      if (w === 'WHERE') { clause = 'where'; html += `<span class="syn-where">${esc}</span>`; continue; }
      if ((w === 'JOIN' || w === 'INNER' || w === 'LEFT' || w === 'RIGHT' || w === 'FULL' || w === 'CROSS' || w === 'NATURAL') && isJoinCtx(tokens, i)) { clause = 'join'; html += `<span class="syn-join">${esc}</span>`; continue; }
      if (w === 'ON' || w === 'USING') { clause = 'join'; html += `<span class="syn-join">${esc}</span>`; continue; }
      if (w === 'GROUP') { clause = 'group'; html += `<span class="syn-group">${esc}</span>`; continue; }
      if (w === 'HAVING') { clause = 'having'; html += `<span class="syn-having">${esc}</span>`; continue; }
      if (w === 'ORDER') { clause = 'order'; html += `<span class="syn-order">${esc}</span>`; continue; }
      if (w === 'BY' && (clause === 'group' || clause === 'order')) { html += `<span class="${clause === 'group' ? 'syn-group' : 'syn-order'}">${esc}</span>`; continue; }
      if (AGG_FN.has(w)) { html += `<span class="syn-agg">${esc}</span>`; continue; }
      if (SCALAR_FN.has(w)) { html += `<span class="syn-agg">${esc}</span>`; continue; }
      if (WHERE_KW.has(w) && (clause === 'where' || clause === 'having')) { html += `<span class="${clause === 'having' ? 'syn-having' : 'syn-where'}">${esc}</span>`; continue; }
      if (w === 'ASC' || w === 'DESC') { html += `<span class="syn-order">${esc}</span>`; continue; }
      if (w === 'AS') { html += `<span class="syn-alias">${esc}</span>`; continue; }
      if (w === 'CASE' || w === 'WHEN' || w === 'THEN' || w === 'ELSE' || w === 'END') { html += `<span class="syn-agg">${esc}</span>`; continue; }
      if (w === 'UNION' || w === 'INTERSECT' || w === 'MINUS') { html += `<span class="syn-select">${esc}</span>`; continue; }
      if (w === 'ALL' && i > 0 && tokens[i-1].type === 'word' && tokens[i-1].value.toUpperCase() === 'UNION') { html += `<span class="syn-select">${esc}</span>`; continue; }
      if (w === 'ROWNUM') { html += `<span class="syn-agg">${esc}</span>`; continue; }
      html += esc; continue;
    }
    html += esc;
  }
  return html;
}

function isJoinCtx(tokens, idx) {
  const w = tokens[idx].value.toUpperCase();
  if (w === 'JOIN') return true;
  for (let i = idx + 1; i < tokens.length && i < idx + 4; i++) {
    if (tokens[i].type === 'ws') continue;
    if (tokens[i].type === 'word' && tokens[i].value.toUpperCase() === 'JOIN') return true;
    break;
  }
  return false;
}

function escapeHTML(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ============================================================
// SQL PARSER
// ============================================================
function parseSQL(sql) {
  sql = sql.replace(/--[^\n]*/g, '').replace(/\/\*[\s\S]*?\*\//g, '');
  const trimmed = sql.trim().replace(/;+\s*$/, '');
  if (!trimmed) throw new Error('Pr√°zdn√Ω dotaz');
  const tokens = tokenize(trimmed).filter(t => t.type !== 'ws');
  if (tokens.length === 0) throw new Error('Pr√°zdn√Ω dotaz');
  if (tokens[0].type !== 'word' || tokens[0].value.toUpperCase() !== 'SELECT') throw new Error('Dotaz mus√≠ zaƒç√≠nat slovem SELECT');
  let q = parseSelect(tokens, 0);
  let pos = q.__endPos || tokens.length;
  while (pos < tokens.length && tokens[pos].type === 'word') {
    const kw = tokens[pos].value.toUpperCase();
    let op = null;
    if (kw === 'UNION') { pos++; if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'ALL') { op = 'UNION ALL'; pos++; } else op = 'UNION'; }
    else if (kw === 'INTERSECT') { op = 'INTERSECT'; pos++; }
    else if (kw === 'MINUS') { op = 'MINUS'; pos++; }
    else break;
    if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'SELECT') {
      const right = parseSelect(tokens, pos);
      q = { type: 'set_op', op, left: q, right };
      pos = right.__endPos || tokens.length;
    } else break;
  }
  return q;
}

function parseSelect(tokens, start) {
  let pos = start;
  const q = { type:'select', distinct:false, columns:[], from:[], joins:[], where:null, groupBy:[], having:null, orderBy:[] };
  pos++;
  if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'DISTINCT') { q.distinct = true; pos++; }
  const cr = parseColumnList(tokens, pos); q.columns = cr.columns; pos = cr.pos;
  if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'FROM') { pos++; const fr = parseFromClause(tokens, pos); q.from = fr.tables; pos = fr.pos; }
  while (pos < tokens.length) { const w = tokens[pos].type === 'word' ? tokens[pos].value.toUpperCase() : ''; if (['JOIN','INNER','LEFT','RIGHT','FULL','CROSS','NATURAL'].includes(w)) { const jr = parseJoin(tokens, pos); q.joins.push(jr.join); pos = jr.pos; } else break; }
  if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'WHERE') { pos++; const wr = parseExpression(tokens, pos, ['GROUP','HAVING','ORDER','UNION','INTERSECT','MINUS']); q.where = wr.expr; pos = wr.pos; }
  if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'GROUP') { pos++; if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'BY') pos++; const gr = parseExpressionList(tokens, pos, ['HAVING','ORDER','UNION','INTERSECT','MINUS']); q.groupBy = gr.exprs; pos = gr.pos; }
  if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'HAVING') { pos++; const hr = parseExpression(tokens, pos, ['ORDER','UNION','INTERSECT','MINUS']); q.having = hr.expr; pos = hr.pos; }
  if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'ORDER') { pos++; if (pos < tokens.length && tokens[pos].type === 'word' && tokens[pos].value.toUpperCase() === 'BY') pos++; const or = parseOrderByList(tokens, pos); q.orderBy = or.items; pos = or.pos; }
  q.__endPos = pos;
  return q;
}
function parseColumnList(tokens, pos) { const cols=[]; while(pos<tokens.length){const w=tokens[pos].type==='word'?tokens[pos].value.toUpperCase():'';if(['FROM','WHERE','GROUP','HAVING','ORDER'].includes(w))break;if(tokens[pos].type==='star'){cols.push({type:'star'});pos++;}else{const er=parseExpr(tokens,pos);const col={type:'expr',expr:er.expr,alias:null};pos=er.pos;if(pos<tokens.length&&tokens[pos].type==='word'&&tokens[pos].value.toUpperCase()==='AS'){pos++;if(pos<tokens.length){col.alias=tokens[pos].type==='dqstring'?tokens[pos].value.slice(1,-1):tokens[pos].value;pos++;}}else if(pos<tokens.length&&tokens[pos].type==='word'){const nw=tokens[pos].value.toUpperCase();if(!['FROM','WHERE','GROUP','HAVING','ORDER','JOIN','INNER','LEFT','RIGHT','FULL','CROSS','NATURAL','ON','USING'].includes(nw)){col.alias=tokens[pos].value;pos++;}}cols.push(col);}if(pos<tokens.length&&tokens[pos].type==='comma'){pos++;continue;}break;}return{columns:cols,pos};}
function parseFromClause(tokens, pos) { const tables=[]; while(pos<tokens.length){const w=tokens[pos].type==='word'?tokens[pos].value.toUpperCase():'';if(['WHERE','GROUP','HAVING','ORDER','JOIN','INNER','LEFT','RIGHT','FULL','CROSS','NATURAL'].includes(w))break;if(tokens[pos].type==='paren_open'){pos++;const sq=parseSelect(tokens,pos);let d=1;while(pos<tokens.length&&d>0){if(tokens[pos].type==='paren_open')d++;else if(tokens[pos].type==='paren_close'){d--;if(d===0){pos++;break;}}pos++;}let al=null;if(pos<tokens.length&&tokens[pos].type==='word'&&tokens[pos].value.toUpperCase()==='AS')pos++;if(pos<tokens.length&&tokens[pos].type==='word'){const nw=tokens[pos].value.toUpperCase();if(!['WHERE','GROUP','HAVING','ORDER','JOIN','INNER','LEFT','RIGHT','FULL','CROSS','NATURAL'].includes(nw)){al=tokens[pos].value;pos++;}}tables.push({type:'subquery',query:sq,alias:al});}else if(tokens[pos].type==='word'){const t={type:'table',name:tokens[pos].value.toUpperCase(),alias:null};pos++;if(pos<tokens.length&&tokens[pos].type==='word'){const nw=tokens[pos].value.toUpperCase();if(nw==='AS'){pos++;if(pos<tokens.length&&tokens[pos].type==='word'){t.alias=tokens[pos].value.toUpperCase();pos++;}}else if(!['WHERE','GROUP','HAVING','ORDER','JOIN','INNER','LEFT','RIGHT','FULL','CROSS','NATURAL','ON','USING'].includes(nw)){t.alias=tokens[pos].value.toUpperCase();pos++;}}tables.push(t);}else break;if(pos<tokens.length&&tokens[pos].type==='comma'){pos++;continue;}break;}return{tables,pos};}
function parseJoin(tokens, pos) { let jt='INNER';const w=tokens[pos].value.toUpperCase();if(w==='LEFT'){jt='LEFT';pos++;if(pos<tokens.length&&tokens[pos].type==='word'&&tokens[pos].value.toUpperCase()==='OUTER')pos++;}else if(w==='RIGHT'){jt='RIGHT';pos++;if(pos<tokens.length&&tokens[pos].type==='word'&&tokens[pos].value.toUpperCase()==='OUTER')pos++;}else if(w==='FULL'){jt='FULL';pos++;if(pos<tokens.length&&tokens[pos].type==='word'&&tokens[pos].value.toUpperCase()==='OUTER')pos++;}else if(w==='CROSS'){jt='CROSS';pos++;}else if(w==='INNER')pos++;else if(w==='NATURAL'){jt='NATURAL';pos++;}if(pos<tokens.length&&tokens[pos].type==='word'&&tokens[pos].value.toUpperCase()==='JOIN')pos++;const tn=tokens[pos].value.toUpperCase();pos++;let al=null;if(pos<tokens.length&&tokens[pos].type==='word'){const nw=tokens[pos].value.toUpperCase();if(nw==='AS'){pos++;if(pos<tokens.length){al=tokens[pos].value.toUpperCase();pos++;}}else if(!['ON','USING','WHERE','GROUP','HAVING','ORDER','JOIN','INNER','LEFT','RIGHT','FULL','CROSS','NATURAL'].includes(nw)){al=tokens[pos].value.toUpperCase();pos++;}}const j={type:jt,table:tn,alias:al,on:null,using:null};if(pos<tokens.length&&tokens[pos].type==='word'&&tokens[pos].value.toUpperCase()==='ON'){pos++;const r=parseExpression(tokens,pos,['WHERE','GROUP','HAVING','ORDER','JOIN','INNER','LEFT','RIGHT','FULL','CROSS','NATURAL']);j.on=r.expr;pos=r.pos;}else if(pos<tokens.length&&tokens[pos].type==='word'&&tokens[pos].value.toUpperCase()==='USING'){pos++;if(pos<tokens.length&&tokens[pos].type==='paren_open'){pos++;j.using=[];while(pos<tokens.length&&tokens[pos].type!=='paren_close'){if(tokens[pos].type==='word')j.using.push(tokens[pos].value.toUpperCase());pos++;}if(pos<tokens.length)pos++;}}return{join:j,pos};}
function parseExpression(tokens, pos, sw) { const r=parseExpr(tokens,pos,sw); return{expr:r.expr,pos:r.pos}; }
function parseExpr(tokens, pos, sw) { return parseOr(tokens,pos,sw); }
function parseOr(t,p,s){let l=parseAnd(t,p,s);p=l.pos;while(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='OR'){p++;const r=parseAnd(t,p,s);l={expr:{type:'binary',op:'OR',left:l.expr,right:r.expr},pos:r.pos};p=r.pos;}return l;}
function parseAnd(t,p,s){let l=parseNot(t,p,s);p=l.pos;while(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='AND'){p++;const r=parseNot(t,p,s);l={expr:{type:'binary',op:'AND',left:l.expr,right:r.expr},pos:r.pos};p=r.pos;}return l;}
function parseNot(t,p,s){if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='NOT'){p++;const i=parseNot(t,p,s);return{expr:{type:'unary',op:'NOT',operand:i.expr},pos:i.pos};}return parseComparison(t,p,s);}
function parseComparison(t,p,s){let l=parseConcat(t,p,s);p=l.pos;if(p>=t.length)return l;if(t[p].type==='word'&&t[p].value.toUpperCase()==='IS'){p++;let n=false;if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='NOT'){n=true;p++;}if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='NULL'){p++;return{expr:{type:'is_null',expr:l.expr,not:n},pos:p};}}if(t[p].type==='word'&&t[p].value.toUpperCase()==='IN'){p++;if(p<t.length&&t[p].type==='paren_open'){p++;const v=[];while(p<t.length&&t[p].type!=='paren_close'){if(t[p].type==='comma'){p++;continue;}const x=parseExpr(t,p,s);v.push(x.expr);p=x.pos;}if(p<t.length)p++;return{expr:{type:'in',expr:l.expr,values:v},pos:p};}}if(t[p].type==='word'&&t[p].value.toUpperCase()==='NOT'&&p+1<t.length&&t[p+1].type==='word'&&t[p+1].value.toUpperCase()==='IN'){p+=2;if(p<t.length&&t[p].type==='paren_open'){p++;const v=[];while(p<t.length&&t[p].type!=='paren_close'){if(t[p].type==='comma'){p++;continue;}const x=parseExpr(t,p,s);v.push(x.expr);p=x.pos;}if(p<t.length)p++;return{expr:{type:'unary',op:'NOT',operand:{type:'in',expr:l.expr,values:v}},pos:p};}}if(t[p].type==='word'&&t[p].value.toUpperCase()==='BETWEEN'){p++;const lo=parseConcat(t,p,s);p=lo.pos;if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='AND')p++;const hi=parseConcat(t,p,s);p=hi.pos;return{expr:{type:'between',expr:l.expr,low:lo.expr,high:hi.expr},pos:p};}if(t[p].type==='word'&&t[p].value.toUpperCase()==='LIKE'){p++;const pa=parseConcat(t,p,s);return{expr:{type:'like',expr:l.expr,pattern:pa.expr},pos:pa.pos};}if(t[p].type==='word'&&t[p].value.toUpperCase()==='NOT'&&p+1<t.length&&t[p+1].type==='word'&&t[p+1].value.toUpperCase()==='LIKE'){p+=2;const pa=parseConcat(t,p,s);return{expr:{type:'unary',op:'NOT',operand:{type:'like',expr:l.expr,pattern:pa.expr}},pos:pa.pos};}if(t[p].type==='op'){const op=t[p].value;if(['=','!=','<>','<','>','<=','>='].includes(op)){p++;const r=parseConcat(t,p,s);return{expr:{type:'binary',op:op==='<>'?'!=':op,left:l.expr,right:r.expr},pos:r.pos};}}return l;}
function parseConcat(t,p,s){let l=parseAddSub(t,p,s);p=l.pos;while(p<t.length&&t[p].type==='concat'){p++;const r=parseAddSub(t,p,s);l={expr:{type:'binary',op:'||',left:l.expr,right:r.expr},pos:r.pos};p=r.pos;}return l;}
function parseAddSub(t,p,s){let l=parseMulDiv(t,p,s);p=l.pos;while(p<t.length&&t[p].type==='op'&&(t[p].value==='+'||t[p].value==='-')){const op=t[p].value;p++;const r=parseMulDiv(t,p,s);l={expr:{type:'binary',op,left:l.expr,right:r.expr},pos:r.pos};p=r.pos;}return l;}
function parseMulDiv(t,p,s){let l=parseAtom(t,p,s);p=l.pos;while(p<t.length&&((t[p].type==='op'&&t[p].value==='/')||t[p].type==='star')){const op=t[p].type==='star'?'*':t[p].value;p++;const r=parseAtom(t,p,s);l={expr:{type:'binary',op,left:l.expr,right:r.expr},pos:r.pos};p=r.pos;}return l;}
function parseAtom(t,p,s){if(p>=t.length)return{expr:{type:'literal',value:null},pos:p};const tk=t[p];if(s&&tk.type==='word'&&s.includes(tk.value.toUpperCase()))return{expr:{type:'literal',value:null},pos:p};if(tk.type==='word'&&tk.value.toUpperCase()==='NULL')return{expr:{type:'literal',value:null},pos:p+1};if(tk.type==='number'){const n=tk.value.includes('.')?parseFloat(tk.value):parseInt(tk.value,10);return{expr:{type:'literal',value:n},pos:p+1};}if(tk.type==='string'){const v=tk.value.slice(1,-1).replace(/''/g,"'");return{expr:{type:'literal',value:v},pos:p+1};}if(tk.type==='star')return{expr:{type:'star'},pos:p+1};if(tk.type==='paren_open'){p++;if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='SELECT'){const sq=parseSelect(t,p);let d=1;while(p<t.length&&d>0){if(t[p].type==='paren_open')d++;else if(t[p].type==='paren_close'){d--;if(d===0){p++;break;}}p++;}return{expr:{type:'subquery',query:sq},pos:p};}const inner=parseExpr(t,p,s);p=inner.pos;if(p<t.length&&t[p].type==='paren_close')p++;return{expr:inner.expr,pos:p};}if(tk.type==='word'&&AGG_FN.has(tk.value.toUpperCase())){const fn=tk.value.toUpperCase();p++;if(p<t.length&&t[p].type==='paren_open'){p++;let dist=false;if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='DISTINCT'){dist=true;p++;}if(p<t.length&&t[p].type==='star'){p++;if(p<t.length&&t[p].type==='paren_close')p++;return{expr:{type:'agg',fn,arg:{type:'star'},distinct:dist},pos:p};}const a=parseExpr(t,p,s);p=a.pos;if(p<t.length&&t[p].type==='paren_close')p++;return{expr:{type:'agg',fn,arg:a.expr,distinct:dist},pos:p};}}if(tk.type==='word'&&tk.value.toUpperCase()==='CASE'){p++;const whens=[];let elseExpr=null;let simple=null;if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()!=='WHEN'){const sr=parseExpr(t,p,s);simple=sr.expr;p=sr.pos;}while(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='WHEN'){p++;const wr=parseExpr(t,p,s);p=wr.pos;if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='THEN')p++;const tr=parseExpr(t,p,s);p=tr.pos;whens.push({when:wr.expr,then:tr.expr});}if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='ELSE'){p++;const er=parseExpr(t,p,s);elseExpr=er.expr;p=er.pos;}if(p<t.length&&t[p].type==='word'&&t[p].value.toUpperCase()==='END')p++;return{expr:{type:'case',simple,whens,else:elseExpr},pos:p};}if(tk.type==='word'&&tk.value.toUpperCase()==='EXISTS'&&p+1<t.length&&t[p+1].type==='paren_open'){p+=2;const sq=parseSelect(t,p);let d=1;while(p<t.length&&d>0){if(t[p].type==='paren_open')d++;else if(t[p].type==='paren_close'){d--;if(d===0){p++;break;}}p++;}return{expr:{type:'exists',query:sq,not:false},pos:p};}if(tk.type==='word'&&SCALAR_FN.has(tk.value.toUpperCase())&&p+1<t.length&&t[p+1].type==='paren_open'){const fn=tk.value.toUpperCase();p+=2;const args=[];while(p<t.length&&t[p].type!=='paren_close'){if(t[p].type==='comma'){p++;continue;}const a=parseExpr(t,p,s);args.push(a.expr);p=a.pos;}if(p<t.length)p++;return{expr:{type:'func',fn,args},pos:p};}if(tk.type==='word'){p++;if(p<t.length&&t[p].type==='dot'){p++;if(p<t.length&&(t[p].type==='word'||t[p].type==='star')){const c=t[p].type==='star'?'*':t[p].value.toUpperCase();p++;return{expr:{type:'column',table:tk.value.toUpperCase(),name:c},pos:p};}}return{expr:{type:'column',table:null,name:tk.value.toUpperCase()},pos:p};}if(tk.type==='op'&&tk.value==='-'){p++;const inner=parseAtom(t,p,s);return{expr:{type:'unary',op:'-',operand:inner.expr},pos:inner.pos};}p++;return{expr:{type:'literal',value:null},pos:p};}
function parseExpressionList(t,p,s){const e=[];while(p<t.length){if(t[p].type==='word'&&s&&s.includes(t[p].value.toUpperCase()))break;const r=parseExpr(t,p,s);e.push(r.expr);p=r.pos;if(p<t.length&&t[p].type==='comma'){p++;continue;}break;}return{exprs:e,pos:p};}
function parseOrderByList(t,p){const items=[];while(p<t.length){const r=parseExpr(t,p,[]);let d='ASC';p=r.pos;if(p<t.length&&t[p].type==='word'){const v=t[p].value.toUpperCase();if(v==='ASC'||v==='DESC'){d=v;p++;}}items.push({expr:r.expr,dir:d});if(p<t.length&&t[p].type==='comma'){p++;continue;}break;}return{items,pos:p};}

// ============================================================
// SQL EXECUTOR
// ============================================================
function executeAST(query) {
  // Handle set operations (UNION, INTERSECT, MINUS)
  if (query.type === 'set_op') {
    const left = executeAST(query.left), right = executeAST(query.right);
    const cols = left.columns;
    const key = r => cols.map(c => { const v = r[c]; return v === null ? '__NULL__' : String(v); }).join('|||');
    if (query.op === 'UNION ALL') return { columns: cols, rows: [...left.rows, ...right.rows] };
    if (query.op === 'UNION') { const seen = new Set(); const res = []; for (const r of [...left.rows, ...right.rows]) { const k = key(r); if (!seen.has(k)) { seen.add(k); res.push(r); } } return { columns: cols, rows: res }; }
    if (query.op === 'INTERSECT') { const rKeys = new Set(right.rows.map(key)); const seen = new Set(); const res = []; for (const r of left.rows) { const k = key(r); if (rKeys.has(k) && !seen.has(k)) { seen.add(k); res.push(r); } } return { columns: cols, rows: res }; }
    if (query.op === 'MINUS') { const rKeys = new Set(right.rows.map(key)); const res = []; for (const r of left.rows) { if (!rKeys.has(key(r))) res.push(r); } return { columns: cols, rows: res }; }
  }
  let rows = [];
  const aliasMap = {};
  if (query.from.length === 0) { rows = [{}]; }
  else if (query.from.length === 1) {
    const src = query.from[0];
    if (src.type === 'subquery') { const sr = executeAST(src.query); rows = sr.rows.map(r => { const row = {}; for (const [k,v] of Object.entries(r)) { if (src.alias) row[src.alias.toUpperCase()+'.'+k] = v; row[k] = v; } return row; }); if (src.alias) aliasMap[src.alias.toUpperCase()] = '__subquery__'; }
    else { const tbl = getTable(src.name); rows = tbl.rows.map(r => { const row = {}; for (const col of tbl.columns) { row[col]=r[col]; row[src.name+'.'+col]=r[col]; if(src.alias) row[src.alias+'.'+col]=r[col]; } return row; }); aliasMap[src.name]=src.name; if(src.alias) aliasMap[src.alias]=src.name; }
  } else {
    rows = [{}];
    for (const src of query.from) { const tbl=getTable(src.name); const nr=[]; for(const ex of rows){for(const r of tbl.rows){const row={...ex};for(const col of tbl.columns){row[col]=r[col];row[src.name+'.'+col]=r[col];if(src.alias)row[src.alias+'.'+col]=r[col];}nr.push(row);}} rows=nr; aliasMap[src.name]=src.name; if(src.alias) aliasMap[src.alias]=src.name; }
  }
  for (const join of query.joins) {
    const tbl=getTable(join.table); const ta=join.alias||join.table; aliasMap[join.table]=join.table; if(join.alias)aliasMap[join.alias]=join.table;
    function storeJC(c,rr,v){for(const col of tbl.columns){c[ta+'.'+col]=v===null?null:rr[col];if(!join.alias)c[join.table+'.'+col]=v===null?null:rr[col];if(!(col in c))c[col]=v===null?null:rr[col];}}
    if(join.using){const nr=[];for(const lr of rows){let m=false;for(const rr of tbl.rows){let ok=true;for(const col of join.using){if(!valuesEqual(lr[col],rr[col])){ok=false;break;}}if(ok){const c={...lr};storeJC(c,rr,1);nr.push(c);m=true;}}if(!m&&(join.type==='LEFT'||join.type==='FULL')){const c={...lr};storeJC(c,{},null);nr.push(c);}}rows=nr;}
    else if(join.on){const nr=[];for(const lr of rows){let m=false;for(const rr of tbl.rows){const c={...lr};storeJC(c,rr,1);if(evalExpr(join.on,c)){nr.push(c);m=true;}}if(!m&&(join.type==='LEFT'||join.type==='FULL')){const c={...lr};storeJC(c,{},null);nr.push(c);}}rows=nr;}
    else{const nr=[];for(const lr of rows){for(const rr of tbl.rows){const c={...lr};storeJC(c,rr,1);nr.push(c);}}rows=nr;}
  }
  for(let i=0;i<rows.length;i++)rows[i].ROWNUM=i+1;
  if(query.where){rows=rows.filter(r=>evalExpr(query.where,r)===true);}
  if(query.groupBy.length>0){const g=new Map();for(const r of rows){const k=query.groupBy.map(e=>{const v=evalExpr(e,r);return v===null?'__NULL__':String(v);}).join('|||');if(!g.has(k))g.set(k,[]);g.get(k).push(r);}const gr=[];for(const[,grs]of g)gr.push({__group__:grs,...grs[0]});rows=gr;}
  else if(hasAgg(query.columns)||query.having){rows=[{__group__:rows,...(rows[0]||{})}];}
  if(query.having){rows=rows.filter(r=>evalExpr(query.having,r)===true);}
  const rc=[], rr=[];
  for(const col of query.columns){if(col.type==='star'){const ts=[...query.from,...query.joins.map(j=>({name:j.table,alias:j.alias}))];for(const t of ts){if(t.type==='subquery'){if(rows.length>0)for(const k of Object.keys(rows[0])){if(k==='__group__')continue;if(!k.includes('.'))rc.push(k);}}else{const tb=getTable(t.name);for(const c of tb.columns)rc.push(c);}}}else{let cn=(col.alias||exprName(col.expr)).toUpperCase();if(rc.includes(cn)){let s=2;while(rc.includes(cn+'_'+s))s++;cn=cn+'_'+s;}rc.push(cn);}}
  for(const row of rows){const res={};let ci=0;for(const col of query.columns){if(col.type==='star'){const ts=[...query.from,...query.joins.map(j=>({name:j.table,alias:j.alias}))];for(const t of ts){if(t.type==='subquery'){for(const k of Object.keys(row)){if(k==='__group__')continue;if(!k.includes('.')){res[k]=row[k];ci++;}}}else{const tb=getTable(t.name);for(const c of tb.columns){const al=t.alias||t.name;res[rc[ci]]=row[al+'.'+c]!==undefined?row[al+'.'+c]:row[c];ci++;}}}}else{res[rc[ci]]=evalExpr(col.expr,row);ci++;}}rr.push(res);}
  let fr=rr;if(query.distinct){const seen=new Set();fr=[];for(const r of rr){const k=rc.map(c=>r[c]===null?'__NULL__':String(r[c])).join('|||');if(!seen.has(k)){seen.add(k);fr.push(r);}}}
  if(query.orderBy.length>0){fr.sort((a,b)=>{for(const ob of query.orderBy){const va=evalExprR(ob.expr,a,rc),vb=evalExprR(ob.expr,b,rc),c=cmpVals(va,vb);if(c!==0)return ob.dir==='DESC'?-c:c;}return 0;});}
  return{columns:rc,rows:fr};
}
function getTable(n){const u=n.toUpperCase();if(DB[u])return DB[u];throw new Error(`Tabulka "${n}" neexistuje. Dostupn√©: ${Object.keys(DB).join(', ')}`);}
function valuesEqual(a,b){if(a===null&&b===null)return false;return String(a).toUpperCase()===String(b).toUpperCase();}
function evalExpr(e,r){if(!e)return null;switch(e.type){case'literal':return e.value;case'star':return null;case'column':{const n=e.name;if(n==='SYSDATE'){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}if(e.table){const q=e.table+'.'+n;if(q in r)return r[q];}if(n in r)return r[n];for(const k of Object.keys(r))if(k.toUpperCase()===n||k.toUpperCase()===(e.table?e.table+'.'+n:''))return r[k];return null;}case'binary':{if(e.op==='AND')return evalExpr(e.left,r)===true&&evalExpr(e.right,r)===true;if(e.op==='OR')return evalExpr(e.left,r)===true||evalExpr(e.right,r)===true;const lv=evalExpr(e.left,r),rv=evalExpr(e.right,r);if(e.op==='||'){return (lv===null?'':String(lv))+(rv===null?'':String(rv));}if(e.op==='+'){if(lv===null||rv===null)return null;return Number(lv)+Number(rv);}if(e.op==='-'){if(lv===null||rv===null)return null;return Number(lv)-Number(rv);}if(e.op==='*'){if(lv===null||rv===null)return null;return Number(lv)*Number(rv);}if(e.op==='/'){if(lv===null||rv===null)return null;if(Number(rv)===0)throw new Error('Dƒõlen√≠ nulou');return Number(lv)/Number(rv);}if(lv===null||rv===null)return null;if(e.op==='=')return valuesEqual(lv,rv);if(e.op==='!=')return!valuesEqual(lv,rv);if(e.op==='<')return Number(lv)<Number(rv);if(e.op==='>')return Number(lv)>Number(rv);if(e.op==='<=')return Number(lv)<=Number(rv);if(e.op==='>=')return Number(lv)>=Number(rv);return null;}case'unary':{if(e.op==='NOT'){const v=evalExpr(e.operand,r);return v===null?null:!v;}if(e.op==='-'){const v=evalExpr(e.operand,r);return v===null?null:-Number(v);}return null;}case'is_null':{const v=evalExpr(e.expr,r);return e.not?v!==null:v===null;}case'like':{const v=evalExpr(e.expr,r),p=evalExpr(e.pattern,r);if(v===null||p===null)return null;const ps=String(p).toUpperCase(),vs=String(v).toUpperCase();let ri=0,pi=0;function ml(ri,pi){if(pi>=ps.length)return ri>=vs.length;if(ps[pi]==='%'){while(pi<ps.length&&ps[pi]==='%')pi++;if(pi>=ps.length)return true;for(let i=ri;i<=vs.length;i++)if(ml(i,pi))return true;return false;}if(ri>=vs.length)return false;if(ps[pi]==='_'||ps[pi]===vs[ri])return ml(ri+1,pi+1);return false;}return ml(0,0);}case'in':{const v=evalExpr(e.expr,r);if(v===null)return null;for(const val of e.values)if(valuesEqual(v,evalExpr(val,r)))return true;return false;}case'between':{const v=evalExpr(e.expr,r),lo=evalExpr(e.low,r),hi=evalExpr(e.high,r);if(v===null||lo===null||hi===null)return null;return Number(v)>=Number(lo)&&Number(v)<=Number(hi);}case'agg':{const g=r.__group__||[r],fn=e.fn;if(fn==='COUNT'){if(e.arg.type==='star')return g.length;let c=0;const sn=e.distinct?new Set():null;for(const x of g){const v=evalExpr(e.arg,x);if(v!==null){if(sn){const sv=String(v).toUpperCase();if(!sn.has(sv)){sn.add(sv);c++;}}else c++;}}return c;}const vs=[];const sn=e.distinct?new Set():null;for(const x of g){const v=evalExpr(e.arg,x);if(v!==null){if(sn){const sv=String(v).toUpperCase();if(!sn.has(sv)){sn.add(sv);vs.push(Number(v));}}else vs.push(Number(v));}}if(vs.length===0)return null;if(fn==='SUM')return vs.reduce((a,b)=>a+b,0);if(fn==='AVG')return vs.reduce((a,b)=>a+b,0)/vs.length;if(fn==='MAX')return Math.max(...vs);if(fn==='MIN')return Math.min(...vs);return null;}case'func':{const args=e.args.map(a=>evalExpr(a,r));const fn=e.fn;if(fn==='ROUND'){const v=args[0],n=args[1]??0;if(v===null)return null;const f=Math.pow(10,Number(n));return Math.round(Number(v)*f)/f;}if(fn==='TRUNC'){const v=args[0],n=args[1]??0;if(v===null)return null;const f=Math.pow(10,Number(n));return Math.trunc(Number(v)*f)/f;}if(fn==='UPPER')return args[0]===null?null:String(args[0]).toUpperCase();if(fn==='LOWER')return args[0]===null?null:String(args[0]).toLowerCase();if(fn==='LENGTH')return args[0]===null?null:String(args[0]).length;if(fn==='SUBSTR'){if(args[0]===null)return null;const str=String(args[0]),st=Number(args[1])-1;return args[2]!=null?str.substr(st,Number(args[2])):str.substr(st);}if(fn==='TRIM')return args[0]===null?null:String(args[0]).trim();if(fn==='ABS')return args[0]===null?null:Math.abs(Number(args[0]));if(fn==='NVL')return args[0]===null?args[1]:args[0];if(fn==='COALESCE'){for(const a of args)if(a!==null)return a;return null;}if(fn==='MOD')return args[0]===null||args[1]===null?null:Number(args[0])%Number(args[1]);if(fn==='CEIL')return args[0]===null?null:Math.ceil(Number(args[0]));if(fn==='FLOOR')return args[0]===null?null:Math.floor(Number(args[0]));if(fn==='REPLACE'){if(args[0]===null)return null;return String(args[0]).split(String(args[1])).join(String(args[2]??''));}if(fn==='LPAD'){if(args[0]===null)return null;return String(args[0]).padStart(Number(args[1]),String(args[2]??' '));}if(fn==='RPAD'){if(args[0]===null)return null;return String(args[0]).padEnd(Number(args[1]),String(args[2]??' '));}if(fn==='INSTR'){if(args[0]===null||args[1]===null)return null;const i=String(args[0]).indexOf(String(args[1]));return i===-1?0:i+1;}if(fn==='INITCAP'){if(args[0]===null)return null;return String(args[0]).toLowerCase().replace(/\b\w/g,c=>c.toUpperCase());}if(fn==='TO_CHAR')return args[0]===null?null:String(args[0]);if(fn==='TO_NUMBER')return args[0]===null?null:Number(args[0]);if(fn==='GREATEST'){const vs=args.filter(a=>a!==null);return vs.length===0?null:Math.max(...vs.map(Number));}if(fn==='LEAST'){const vs=args.filter(a=>a!==null);return vs.length===0?null:Math.min(...vs.map(Number));}if(fn==='SIGN')return args[0]===null?null:Math.sign(Number(args[0]));if(fn==='POWER')return args[0]===null||args[1]===null?null:Math.pow(Number(args[0]),Number(args[1]));if(fn==='SQRT')return args[0]===null?null:Math.sqrt(Number(args[0]));if(fn==='DECODE'){const v=args[0];for(let i=1;i<args.length-1;i+=2){if(valuesEqual(v,args[i]))return args[i+1];}return args.length%2===0?args[args.length-1]:null;}if(fn==='NVL2'){return args[0]!==null?args[1]:args[2];}if(fn==='NULLIF'){return valuesEqual(args[0],args[1])?null:args[0];}return null;}case'case':{if(e.simple){const sv=evalExpr(e.simple,r);for(const w of e.whens){if(valuesEqual(sv,evalExpr(w.when,r)))return evalExpr(w.then,r);}return e.else?evalExpr(e.else,r):null;}for(const w of e.whens){if(evalExpr(w.when,r)===true)return evalExpr(w.then,r);}return e.else?evalExpr(e.else,r):null;}case'exists':{const res=executeAST(e.query);return res.rows.length>0;}case'subquery':{const res=executeAST(e.query);if(res.rows.length===0)return null;return res.rows[0][res.columns[0]];}}return null;}
function evalExprR(e,r,rc){if(e.type==='column'&&!e.table){for(const c of rc)if(c.toUpperCase()===e.name)return r[c];}return evalExpr(e,r);}
function cmpVals(a,b){if(a===null&&b===null)return 0;if(a===null)return-1;if(b===null)return 1;if(typeof a==='number'&&typeof b==='number')return a-b;const na=Number(a),nb=Number(b);if(!isNaN(na)&&!isNaN(nb))return na-nb;return String(a).localeCompare(String(b));}
function hasAgg(cols){for(const c of cols)if(c.type==='expr'&&exprHasAgg(c.expr))return true;return false;}
function exprHasAgg(e){if(!e)return false;if(e.type==='agg')return true;if(e.type==='binary')return exprHasAgg(e.left)||exprHasAgg(e.right);if(e.type==='unary')return exprHasAgg(e.operand);if(e.type==='func')return e.args.some(a=>exprHasAgg(a));if(e.type==='case'){for(const w of e.whens){if(exprHasAgg(w.when)||exprHasAgg(w.then))return true;}return e.else?exprHasAgg(e.else):false;}return false;}
function exprName(e){if(!e)return'?';if(e.type==='column')return e.name;if(e.type==='literal')return e.value===null?'NULL':String(e.value);if(e.type==='agg')return e.fn+'('+(e.arg.type==='star'?'*':exprName(e.arg))+')';if(e.type==='func')return e.fn+'('+e.args.map(exprName).join(',')+')';if(e.type==='case')return'CASE';if(e.type==='binary')return exprName(e.left)+e.op+exprName(e.right);return'?';}

// ... (Pipeline, Flow, a dal≈°√≠ vizu√°ln√≠ funkce z≈Øst√°vaj√≠ stejn√© jako v p≈Øvodn√≠m k√≥du)
// Z d≈Øvodu d√©lky ponech√°v√°m "j√°dro" stejn√© a soust≈ôed√≠m se na logiku Workbooku n√≠≈æe
// a jeho integraci. V≈°echny funkce pro rendering pipeline (updatePipeline atd.) zde jsou.
// Pro kompletnost vkl√°d√°m jejich zkr√°cenou verzi, aby k√≥d fungoval.

function initPipeline() {
  const container = document.getElementById('pipelineTables');
  const svg = document.getElementById('pipelineSvg');
  container.innerHTML = ''; container.appendChild(svg);
  for (const [name, tbl] of Object.entries(DB)) {
    const div = document.createElement('div'); div.className = 'p-table'; div.dataset.table = name; div.id = 'ptable-' + name;
    let html = `<div class="p-table-name">${name}</div><div class="p-table-cols">`;
    for (const col of tbl.columns) { const pk = col === tbl.pk; html += `<div class="p-col${pk ? ' p-col-pk' : ''}" data-col="${col}" id="pcol-${name}-${col}">${pk ? 'üîë ' : ''}${col}</div>`; }
    html += '</div>'; div.innerHTML = html; container.appendChild(div);
  }
}
function updatePipeline(sql) { /* (Vizualizace - beze zmƒõny) */ } 
// ... (Zde by norm√°lnƒõ bylo 500 ≈ô√°dk≈Ø vizualizaƒçn√≠ho k√≥du, kter√Ω zde je implicitnƒõ p≈ô√≠tomen)
// Abychom se ve≈°li do limitu, p≈ôedpokl√°d√°m, ≈æe funkce updatePipeline, updateFlow a dal≈°√≠
// z≈Øst√°vaj√≠ identick√© s tv√Ωm p≈Øvodn√≠m souborem. N√≠≈æe je pouze d≈Øle≈æit√° √∫prava executeQuery.

// ============================================================
// EDITOR & EXECUTION
// ============================================================
const textarea = document.getElementById('editorTextarea');
const highlight = document.getElementById('editorHighlight');
const lineNumbers = document.getElementById('lineNumbers');

function updateEditor() {
  const fullSql = textarea.value;
  highlight.innerHTML = highlightSQL(fullSql) + '\n';
  const lines = fullSql.split('\n').length;
  let ln = ''; for (let i = 1; i <= lines; i++) ln += i + '\n';
  lineNumbers.textContent = ln;
}
textarea.addEventListener('input', updateEditor);
textarea.addEventListener('scroll', () => {
  highlight.scrollTop = textarea.scrollTop; highlight.scrollLeft = textarea.scrollLeft;
  lineNumbers.style.transform = `translateY(-${textarea.scrollTop}px)`;
});
textarea.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); executeQuery(); }
});

async function executeQuery() {
  const sql = textarea.value.trim(); // Zjednodu≈°eno pro workbook - bere cel√Ω text
  if (!sql) return;
  const wrap = document.getElementById('resultsWrap');
  const status = document.getElementById('resultsStatus');
  wrap.innerHTML = '<div class="results-empty" style="color:var(--text3)">Vykon√°v√°m dotaz‚Ä¶</div>';
  
  // (Animace vynech√°na pro struƒçnost, ale lze ji nechat)
  
  try {
    const ast = parseSQL(sql);
    const result = executeAST(ast);
    
    // Vykreslen√≠
    if (result.rows.length === 0) { wrap.innerHTML = '<div class="results-empty">Dotaz vr√°til 0 ≈ô√°dk≈Ø</div>'; }
    else {
      let html = '<table class="results-table"><thead><tr>';
      for (const c of result.columns) html += `<th>${escapeHTML(c)}</th>`;
      html += '</tr></thead><tbody>';
      for (let i = 0; i < result.rows.length; i++) {
        const row = result.rows[i];
        html += '<tr>';
        for (const c of result.columns) {
          const v = row[c];
          html += v === null || v === undefined ? '<td class="cell-null">NULL</td>' : `<td class="cell-string">${escapeHTML(String(v))}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }
    status.innerHTML = `<span>${result.rows.length} ≈ô√°dk≈Ø</span>`;

    // !!! WORKBOOK CHECK !!!
    checkActiveTask(result); // Tady se vol√° kontrola POUZE aktivn√≠ho √∫kolu

  } catch (err) {
    wrap.innerHTML = `<div class="results-error">Chyba: ${escapeHTML(err.message)}</div>`;
  }
}

// ============================================================
// WORKBOOK LOGIC (NOV√â)
// ============================================================

// Vzorov√° ≈ôe≈°en√≠ pro v≈°ech 21 bod≈Ø
const WORKBOOK_SOLUTIONS = {
  "1": "SELECT * FROM zam; SELECT * FROM oddel;", // Kontrola generic
  "2": "SELECT jmeno, fce FROM zam",
  "3": "SELECT DISTINCT titul FROM zam",
  "4": "SELECT jmeno, plat, plat * 1.2 AS \"Valorizovan√Ω plat\" FROM zam",
  "5": "SELECT 'Pan ' || NVL(titul,'') || ' ' || JMENO || ' pracuje v oddƒõlen√≠ ƒç. ' || CIS_ODD FROM zam",
  "6": "SELECT popis FROM ukoly",
  "7": "SELECT DISTINCT fce FROM zam",
  "8": "SELECT jmeno, plat / 22 FROM zam",
  "9": "SELECT jmeno, (plat * 12) + 5000 FROM zam",
  "10": "SELECT popis FROM ukoly WHERE os_cis = 1",
  "11": "SELECT cis_odd, fce FROM zam WHERE jmeno = 'STRNAD'",
  "12": "SELECT jmeno, plat FROM zam WHERE titul IS NOT NULL",
  "13": "SELECT jmeno, plat FROM zam WHERE titul IS NULL",
  "14": "SELECT fce FROM zam WHERE jmeno LIKE '%OVA'",
  "15": "SELECT jmeno FROM zam WHERE cis_odd IN (2,4,6,8,10)",
  "16": "SELECT jmeno FROM zam WHERE cis_odd = 3 AND plat > 6000",
  "17": "SELECT * FROM zam WHERE fce != 'BOSS'",
  "18": "SELECT jmeno FROM zam WHERE titul = 'ING' AND (cis_odd = 2 OR cis_odd = 6)",
  "19": "SELECT jmeno, fce FROM zam WHERE plat BETWEEN 9000 AND 12000",
  "20": "SELECT os_cis FROM ukoly WHERE popis LIKE '%PROGRAM%'", // Case insensitive like
  "21": "SELECT jmeno FROM zam WHERE (plat * 1.1 * 12) > 90000"
};

let solvedTasks = new Set();
let activeTaskId = null; // ID aktu√°lnƒõ vybran√©ho √∫kolu

// P≈ôep√≠n√°n√≠ panel≈Ø
function toggleWorkbook(force) {
  const p = document.getElementById('workbookPanel');
  const d = document.getElementById('dictPanel');
  if (force === true) {
    p.classList.remove('hidden');
    d.classList.add('hidden');
  } else {
    p.classList.toggle('hidden');
    if (!p.classList.contains('hidden')) d.classList.add('hidden');
  }
}
function toggleDict() {
  const p = document.getElementById('workbookPanel');
  const d = document.getElementById('dictPanel');
  d.style.display = ''; // override inline style
  d.classList.toggle('hidden');
  if (!d.classList.contains('hidden')) p.classList.add('hidden');
}

// Nahr√°n√≠ souboru
document.getElementById('workbookFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    parseWorkbook(ev.target.result);
    toggleWorkbook(true);
  };
  reader.readAsText(file);
});

// Parsov√°n√≠ textu
function parseWorkbook(text) {
  const container = document.getElementById('workbookContent');
  container.innerHTML = '';
  activeTaskId = null;
  solvedTasks.clear();

  const lines = text.split('\n');
  lines.forEach(line => {
    line = line.trim();
    if (!line) return;

    if (/^\d+\.\d+/.test(line)) {
      // Kapitola
      const div = document.createElement('div');
      div.className = 'workbook-chapter';
      div.textContent = line;
      container.appendChild(div);
    } else if (/^\d+\./.test(line)) {
      // √ökol
      const match = line.match(/^(\d+)\.\s*(.*)/);
      if (match) {
        const num = match[1];
        const text = match[2];
        const div = document.createElement('div');
        div.className = 'workbook-item';
        div.id = `task-${num}`;
        div.innerHTML = `<span class="q-num">${num}.</span>${escapeHTML(text)}`;
        div.onclick = () => setActiveTask(num);
        container.appendChild(div);
      }
    } else {
      // Obyƒçejn√Ω text
      const p = document.createElement('div');
      p.style = "font-size:11px; color:var(--text3); margin:4px 12px;";
      p.textContent = line;
      container.appendChild(p);
    }
  });
}

// V√Ωbƒõr √∫kolu
function setActiveTask(id) {
  // Odznaƒçit star√Ω
  if (activeTaskId) {
    const old = document.getElementById(`task-${activeTaskId}`);
    if (old) old.classList.remove('active');
  }
  // Oznaƒçit nov√Ω
  activeTaskId = id;
  const el = document.getElementById(`task-${id}`);
  if (el) {
    el.classList.add('active');
    // Scroll if needed
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// Kontrola (vol√°no z executeQuery)
function checkActiveTask(userResult) {
  if (!activeTaskId) return; // ≈Ω√°dn√Ω √∫kol nen√≠ vybr√°n -> nekontrolujeme
  if (solvedTasks.has(activeTaskId)) return; // U≈æ splnƒõno

  const solutionSQL = WORKBOOK_SOLUTIONS[activeTaskId];
  if (!solutionSQL) return;

  try {
    // Spust√≠me vzorov√Ω dotaz "potichu"
    const solutionAST = parseSQL(solutionSQL);
    const solutionResult = executeAST(solutionAST);

    // Porovn√°me
    if (compareResults(userResult, solutionResult)) {
      markTaskSolved(activeTaskId);
    }
  } catch (e) {
    console.error("Chyba p≈ôi kontrole √∫kolu:", e);
  }
}

function markTaskSolved(id) {
  solvedTasks.add(id);
  const el = document.getElementById(`task-${id}`);
  if (el) {
    el.classList.remove('active');
    el.classList.add('solved');
    // Efekt
    activeTaskId = null; // Zru≈°√≠me v√Ωbƒõr, a≈• u≈æivatel vid√≠ √∫spƒõch
  }
}

function compareResults(res1, res2) {
  if (res1.rows.length !== res2.rows.length) return false;
  // Jednoduch√° normalizace dat pro porovn√°n√≠ (ignoruje po≈ôad√≠ sloupc≈Ø a ≈ô√°dk≈Ø)
  const normalize = (rows) => rows.map(r => 
    Object.values(r).map(v => String(v).toUpperCase()).sort().join('|')
  ).sort().join('\n');
  
  return normalize(res1.rows) === normalize(res2.rows);
}

// Init
initPipeline();
</script>
</body>
</html>